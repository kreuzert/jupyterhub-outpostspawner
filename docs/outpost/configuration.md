# Configuration

JupyterHub Outpost configuration is nearly the same as the JupyterHub Spawner configuration.
The easiest way is to write the configuration in the key `outpostConfig` in the `values.yaml` file.
  
In this example all single-user servers will be started with the same image. The JupyterHub OutpostSpawner can override each `c.<Spawner>.<key>` value, using the `custom_misc` feature. For more information look into the OutpostSpawner configuration.
```
cat <<EOF >> values.yaml
... don't forget to keep the values from the installation section
outpostConfig: |
  from kubespawner import KubeSpawner
  c.JupyterHubOutpost.spawner_class = KubeSpawner
  c.KubeSpawner.image = "jupyter/minimal-notebook:notebook-7.0.3"
EOF

helm upgrade --install -f values.yaml outpost jupyterhub-outpost/jupyterhub-outpost
```

## Customize Logging
For the logging configuration the Outpost offers these options (all used the same as for JupyterHub):
```
c.JupyterHubOutpost.log_level = ...
c.JupyterHubOutpost.log_datafmt = ...
c.JupyterHubOutpost.log_format = ...
```

If more customization is required, one can do this directly in the configuration itself.
```
class TornadoGeneralLoggingFilter(logging.Filter):
  def filter(self, record):
    # I don't want to see this log line generated by tornado
    if str(record.msg).startswith("Could not open static file"):
      return False
    return True

logging.getLogger("tornado.general").addFilter(TornadoGeneralLoggingFilter())

import os
logged_logger_name = os.environ.get("LOGGER_NAME", "MyOutpostInstance")
c.JupyterHubOutpost.log_format = f"%(color)s[%(levelname)1.1s %(asctime)s.%(msecs).03d {logged_logger_name} %(name)s %(module)s:%(lineno)d]%(end_color)s %(message)s"
```

## Persistent database
Outpost uses environment variables to [connect](https://gitlab.jsc.fz-juelich.de/jupyterjsc/k8s/images/jupyterhub-outpost/-/blob/main/project/app/database/__init__.py) to a database. In default cases the database will be a file, which will be deleted when Outpost is restarted. To enable a persistent database, one should use postgres. If you want to use a database that is not supported yet, feel free to open an issue and we will add this in the next update.  

```
SQL_TYPE = "postgresql"
SQL_DATABASE = "<database_name>"
SQL_HOST = "postgresql.database.svc"
SQL_PASSWORD = "<password>"
SQL_PORT = "5432"
SQL_USER = "<username>"

kubectl create secret generic --from-literal=SQL_TYPE=${SQL_TYPE} --from-literal=SQL_DATABASE=${SQL_DATABASE} --from-literal=SQL_HOST=${SQL_HOST} --from-literal=SQL_PASSWORD=${SQL_PASSWORD} --from-literal=SQL_PORT=${SQL_PORT} --from-literal=SQL_USER=${SQL_USER} outpost-database

cat <<EOF >> values.yaml
... don't forget to keep the other values
extraEnvVarsSecrets:
  - outpost-database
EOF

helm upgrade --install -f values.yaml outpost jupyterhub-outpost/jupyterhub-outpost
```

## Sanitize Spawner.start response
JupyterHub Outpost will use the return value of the start function of the configured SpawnerClass, to tell JupyterHub where the single-user server will be running. For example in the KubeSpawner, the response of KubeSpawner.start() will be something like `http://jupyter-<id>-<user_id>:<port>`. The JupyterHub OutpostSpawner will take this information, and create a ssh port-forwarding process with the option `-L 0.0.0.0:<local_jhub_port>:jupyter-<id>-<user_id>:<port>`. Afterwards, JupyterHub will look for the newly created single-user server at `http://localhost:<local_jhub_port>`. If the response of the start function of the configured SpawnerClass in the JupyterHub Outpost service will not be correct, OutpostSpawner and Outpost can not work together properly. To ensure nearly all Spawners can be used anyway, you can override the response send to the OutpostSpawner.

```
# This may be a coroutine
def sanitize_start_response(spawner, original_response):
  # ... determine the correct location for the new single-user server
  return "<...>"

c.JupyterHubOutpost.sanitize_start_response = sanitize_start_response
```

If you don't know where your single-user server will be running in the end, you have to return an empty string. JupyterHub OutpostSpawner won't create a ssh port-forwarding process. The start process of the single-user server has to send a POST request to the `$JUPYTERHUB_SETUPTUNNEL_URL` url. Have a look at the API Endpoints of the OutpostSpawner for more information.
